#
#	.shrc - per-shell startup stuff for non-POSIX compatible /bin/sh
#
#ident	"@(#)HOME:.shrc	35.1	13/12/02 18:39:34 (woods)"

PATH="$PATH"
export PATH

dirappend ()
{
	if [ $# -le 1 ] ; then
		echo "Usage: dirappend variable directory [...]" >&2
		exit 2
	fi
	varname=$1
	shift
	eval varvalue='$'$varname
	while [ $# -gt 0 ] ; do
		if [ -d "$1" -a `expr ":$varvalue:" : ".*:$1:.*"` -eq 0 ] ; then
			eval $varname='$'"$varname"'":$1"'
		fi
		shift
	done
	unset varname varvalue
}

dirprepend ()
{
	if [ $# -le 1 ] ; then
		echo "Usage: dirprepend variable directory [...]" >&2
		exit 2
	fi
	varname=$1
	shift
	eval varvalue='$'$varname
	while [ $# -gt 0 ] ; do
		if [ -d "$1" -a `expr ":$varvalue:" : ".*:$1:.*"` -eq 0 ] ; then
			eval $varname='"$1:"$'"$varname"
		fi
		shift
	done
	unset varname varvalue
}

lnotes ()
{
	if [ -d $HOME/notes ] ; then
	(
		# in a subshell
		cd $HOME/notes
		if [ `ls|wc -w` != 0 ] ; then
			echo 'You have notes on:' 
			ls -C *[!~]
		fi
	)
	fi
}

# for window systems which don't emulate login sessions in each window
#
do_first_time ()
{
	if [ -x /usr/games/fortune ] ; then
		/usr/games/fortune
	elif [ -x "$FORTUNE" ] ; then
		$FORTUNE
	fi
	if [ -r calendar -o -r .month ] ; then
		print "\nToday's Events:"
		if [ -r .month ] ; then
			month -B
		fi
		if [ -r calendar ] ; then
			calendar
		fi
	fi
	lnotes
	if [ -r $HOME/.trninit$TERM ] ; then
		TRNINIT="$HOME/.trninit$TERM" ; export TRNINIT
	fi
}

#
# always use ``$echo'' if any of the other variables are used...
#	$nl - print a newline (always required at end of line if desired)
#	$n - option to turn off final newline
#	$c - escape sequence to turn off final newline
# usage for a prompt is:
#	$echo $n "prompt: $c"
# and for a normal line
#	$echo "message$nl"
#
echo=echo
(echo "hi there\c" ; echo " ") >$HOME/echotmp
# Configure checks to make sure grep returns a status...
if grep c $HOME/echotmp >/dev/null 2>&1 ; then
	nl=''
	n='-n'
	c=''
else
	nl='\n'
	n=''
	c='\c'
fi
rm -f $HOME/echotmp

# NOTE: we don't export $echo et al -- they're just in the current shell

# UGLY, but it works
#
# WARNING: this sed expression breaks if there isn't a group-id for each gid
#
eval "`id|sed -e 's/^uid=\([0-9]*\)(\(..*\)) gid=[0-9]*(\([^) ]*\)).*$/id=\1 uid=\2 gid=\3/'`"

if [ "$id" -eq 0 ] ; then
	# got to get rid of lone ":" or any "." in PATH
	PATH="`echo $PATH | sed -e 's/::/:/g' -e 's/^://' -e 's/:$//' -e 's/^\.://' -e 's/:\.://' -e 's/:\.$//'`"
	if $ISSUN; then
		PATH="`echo $PATH | sed -e 's~^/bin:~~' -e 's~:/etc:~:~'`"
		dirprepend PATH /usr/5bin
		dirappend PATH /usr/openwin/bin
	else
		dirprepend PATH /etc
	fi
	dirprepend PATH /sbin /usr/sbin
	dirappend PATH /usr/etc /usr/lbin /usr/ucb $X11BIN
	if [ -n "$LOCAL" ] ; then
		dirappend PATH $LOCAL/sbin $LOCAL/bin
		if [ ! -d $LOCAL/sbin ] ; then
			dirappend PATH $LOCAL/etc
		fi
	fi
	if [ -n "$GNU" ] ; then
		dirappend PATH $GNU/sbin $GNU/bin
		if [ ! -d $GNU/sbin ] ; then
			dirappend PATH $GNU/etc
		fi
	fi
	if [ -n "$CONTRIB" ] ; then
		dirappend PATH $CONTRIB/sbin $CONTRIB/bin
		if [ ! -d $CONTRIB/sbin ] ; then
			dirappend PATH $CONTRIB/etc
		fi
	fi
	if [ -n "$PKG" ] ; then
		dirappend PATH $PKG/sbin $PKG/bin
		if [ ! -d $PKG/sbin ] ; then
			dirappend PATH $PKG/etc
		fi
	fi
	dirappend PATH /usr/lib/uucp /usr/lib
	dirappend PATH $HOME/bin
	PS1="$TTYN:<$LOGNAME@$UUNAME> # "
elif [ "$uid" != "$LOGNAME" ] ; then
	PS1="$TTYN:<$uid($LOGNAME)@$UUNAME)> $ "
else
	PS1="$TTYN:<$LOGNAME@$UUNAME> $ "
fi
if type ismpx 2>&1 >/dev/null ; then
	: might just be running layers
else
	# otherwise it's just not possible....
	ismpx ()
	{
		false
	}
fi

if [ "`ismpx`" = yes -o "$TERM" = "dmd-myx" ] ; then
	if [ "$LEV" -eq 0 ] ; then
		do_first_time	# in xterms, we are a login shell, but not in layers
	fi
	MYXCLR_L="`myxban -l`"
	MYXCLR_C="`myxban -c`"
	MYXCLR_R="`myxban -r`"
	MYXCLR="${MYXCLR_L}${MYXCLR_C}${MYXCLR_R}"
	MYXBAN_L='`pwd`'

	alias clearban='${echo} "${MYXCLR}${c}"'

	setban ()
	{
		clearban
		eval myxban -l "\"$MYXBAN_L\""
		myxban -c "${WBANNER}"
		eval myxban -r "\"$MYXBAN_R\""
	}

# most versions of SysV sh always run builtins before functions
#
#	cd ()
#	{
#		chdir ${1+"$@"}
#		eval myxban -l "\"$MYXBAN_L\""
#	}

	setban
fi

if [ "$TERM" = "xterm" ] ; then
	clearban ()
	{
		WBANNER=""
		setban
	}

	setban ()
	{
		BANNERWD=`pwd | sed -e "s;^$HOME;~;" -e 's;^.*/work.d/;work.d/;' -e 's;.*/home.*/\([^/][^/]*\)$;\~\1;'`
		eval TBANNER='"${WBANNER:-sh}://$UUNAME/${BANNERWD} | $uid{$gid}($LOGNAME)[$LEV]:$TTYN"'
		$echo "]0;$TBANNER$c"
		WBANNER=""
	}

# most versions of SysV sh always run builtins before functions
#
#	cd ()
#	{
#		chdir ${1+"$@"}
#		BANNERWD=`pwd | sed -e "s;^$HOME;~;" -e 's;^.*/work.d/;work.d/;' -e 's;.*/home.*/\([^/][^/]*\)$;\~\1;'`
#		setban 
#	}

	setban
fi

if $ISSUN; then
	df ()
	{
		/usr/bin/df ${1+"$@"}
	}
fi
if [ -d /var/spool/uucp ] ; then
	uufollow ()
	{
		xtail /var/spool/uucp/.[AL]*/*
	}
else
	uufollow ()
	{
		xtail /usr/spool/uucp/.[AL]*/*
	}
fi

if [ -x /usr/ucb/rsh -a -x /bin/rsh ] ; then
	rsh ()
	{
		/usr/ucb/rsh ${1+"$@"}
	}
fi

if [ -r $HOME/.shsccs ] ; then
	. $HOME/.shsccs
fi

if [ -f /usr/share/misc/na.phone ]; then
	areacode ()
	{
		grep ${1+"$@"} /usr/share/misc/*.phone
	}
fi

errno ()
{
	grep "^#define[ 	]*[A-Z][A-Z]*[ 	]*$1[ 	]" /usr/include/sys/errno.h
}

lastcmd ()
{
	tr '[\001-\007]' '[\012*]' < .sh_history | \
		tr '[\176-\377]' '[ *]' | \
		egrep -v '^[	 }#]|^$' | \
		tail ${1+"$@"}
}

malias ()
{
	grep "alias[ 	]$*" $LOCAL/lib/mush/Mail.rc ~/.mushrc
}

signm ()
{
	grep "^#define[ 	]*SIG.*[ 	]*${1}[ 	]" /usr/include/sys/signal.h
}

signo ()
{
	grep -i "^#define[ 	]*.*${1}[ 	]*[0-9]" /usr/include/sys/signal.h
}

typeof ()
{
	if $ISSUN; then
		LLIBDIR=/usr/lib/lint
	else
		LLIBDIR=/usr/lib
	fi
	# should expand to allow '-l{lib}'
	egrep -i "$1" $LLIBDIR/llib-lc $LLIBDIR/llib-lm $LLIBDIR/llib-lcurses
	unset LLIBDIR
}

#
# the rest are implementations of favourite ksh aliases as functions
#

blstrip ()
{
	sed "/./,/^$/!d"
}
ds ()
{
	$PAGER ${1+"$@"}
}
e ()
{
	${VISUAL:-$EDITOR} ${1+"$@"}
}
elc ()
{
	emacs -batch -q -no-site-file -f batch-byte-compile
}
l ()
{
	/bin/ls -CF ${1+"$@"}
}
la ()
{
	/bin/ls -CFa ${1+"$@"}
}
ll ()
{
	/bin/ls -lis ${1+"$@"}
}
lla ()
{
	/bin/ls -lisa ${1+"$@"}
}
llr ()
{
	/bin/ls -lisR ${1+"$@"}
}
llra ()
{
	/bin/ls -lisaR ${1+"$@"}
}
lr ()
{
	/bin/ls -CFR ${1+"$@"}
}
lra ()
{
	/bin/ls -CFRa ${1+"$@"}
}
lsa ()
{
	/bin/ls -a ${1+"$@"}
}
nstty ()
{
	stty sane intr "^?" erase "^h" kill "^u" echoe echok
}
maillog ()
{
	$PAGER -e -p ": \[[0-9]*\] remote [A-Z ]*:" +G $MAILLOG
}
rstty ()
{
	stty $SANE
}
wcvs ()
{
	print $CVSROOT
}
